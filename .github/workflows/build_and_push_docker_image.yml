name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build_and_push_image:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Add registry to /etc/hosts
      run: echo "${{ vars.SERVER_URL }} ${{ vars.REGISTRY }}" | sudo tee -a /etc/hosts
    
    - name: Install CA certificate
      run: |
        sudo mkdir -p /etc/docker/certs.d/${{ vars.REGISTRY }}:5000
        echo "${{ secrets.CA_CERT }}" | sudo tee /etc/docker/certs.d/${{ vars.REGISTRY }}:5000/ca.crt
        sudo systemctl restart docker

    - name: Build and push Docker image
      run: |
        VERSION=$(date +%s)
        docker build . --file Dockerfile --tag ${{ vars.REGISTRY }}:5000/wish-react-app:$VERSION
        docker push ${{ vars.REGISTRY }}:5000/wish-react-app:$VERSION 
